# wrictools

## Overview

This package provides functions, tutorials, and examples to preprocess,
analyze, and visualize data from whole room indirect calorimeters (WRIC)
by Maastricht Instruments, using the ‘OmniCal’ software. Some functions
may also work with WRICs from other manufacturers, though full
functionality has only been validated for Maastricht Instruments
devices.

If you instead want to use the functions in Python, please click below.
Please note, that the Python code will not be further maintained as of
March 2025.
[![pt-br](https://img.shields.io/badge/Python-yellow.svg)](https://github.com/hulmanlab/wrictools/blob/main/README.python.md)

## Installation

``` r
# Install from CRAN
install.packages("wrictools")
```

If instead you want to install `wrictools` from GitHub use:

``` r
library(remotes)
install_github( "NinaZiegenbein/wrictools")
```

## Example Usage

### Preprocess Local WRIC file(s)

If you have a WRIC text file locally and want to preprocess it, the
workflow involves reading the metadata at the top of the file,
extracting the raw measurements into a structured CSV format, and
trimming the dataset to only include rows between the specified study
start and end times. Additional steps include adding a relative time
variable, combining the two measurement streams, and optionally
splitting the data by room (room1 and room2) before saving the final
output as a CSV file. Many of these steps are parameter-controlled,
allowing you to choose which actions to apply during preprocessing.

*Note: The data.txt in the /data folder is synthetic data intended to
highlight the data pipeline, but should not be used for actual analysis
as it is unphysiological and does not correlate to the note.txt file
either!*

``` r
library(wrictools)

data_txt <- system.file("extdata", "data.txt", package = "wrictools") # loading example data
result <- preprocess_wric_file(data_txt) 
#> Rows: 717 Columns: 67
#> ── Column specification ────────────────────────────────────────────────────────
#> Delimiter: "\t"
#> chr   (4): X1, X18, X35, X52
#> dbl  (56): X3, X4, X5, X6, X7, X8, X9, X10, X11, X12, X13, X14, X15, X16, X2...
#> lgl   (3): X17, X34, X51
#> time  (4): X2, X19, X36, X53
#> 
#> ℹ Use `spec()` to retrieve the full column specification for this data.
#> ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
```

The above code specifies only the necessary parameter `filepath` and
assumes the default values for all other parameters. But you can specify
these parameters for yourself, as can be seen below. As these are the
default options the two function calls return exactly the same results.

``` r
result <- preprocess_wric_file(
    data_txt, 
    code="id", 
    manual=NULL, 
    save_csv=FALSE, 
    path_to_save=NULL, 
    combine=TRUE, 
    method="mean",
    start=NULL,
    end=NULL,
    notefilepath= NULL,
    keywords_dict=NULL
)
#> Rows: 717 Columns: 67
#> ── Column specification ────────────────────────────────────────────────────────
#> Delimiter: "\t"
#> chr   (4): X1, X18, X35, X52
#> dbl  (56): X3, X4, X5, X6, X7, X8, X9, X10, X11, X12, X13, X14, X15, X16, X2...
#> lgl   (3): X17, X34, X51
#> time  (4): X2, X19, X36, X53
#> 
#> ℹ Use `spec()` to retrieve the full column specification for this data.
#> ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
```

Here are explanations and options to all parameters you can specify:

- **filepath:** \[String, filepath\] Directory path to the WRIC .txt
  file.
- **code** \[String\] Method for generating subject IDs. Default is
  “id”, also possible to specify “id+comment”, where both ID and comment
  values are combined or “manual”, where you can specify your own.
- **manual** \[String\] Custom codes for subjects in Room 1 and Room 2
  if `code` is “manual”.
- **save_csv** \[Logical\], whether to save extracted metadata and data
  to CSV files or not. Default is False
- **path_to_save** \[String\] Directory path for saving CSV files, NULL
  uses the current directory, NULL is Default.
- **combine** \[Logical\], whether to combine S1 and S2 measurements.
  Default is True
- **method** \[String\] Method for combining measurements (“mean”,
  “median”, “s1”, “s2”, “min”, “max”).
- **start** \[character or POSIXct or NULL\], rows before this will be
  removed, if NULL takes first row e.g “2023-11-13 11:43:00”
- **end** \[character or POSIXct or NULL\], rows after this will be
  removed, if NULL takes last rows e.g “2023-11-13 11:43:00”
- **notefilepath:** If you specify a path to the corresponding notefile,
  the code will try to automatically extract the datetime and current
  protocol specification (sleeping, exercising, eating etc). If possible
  please read the [How To Note
  File](https://github.com/hulmanlab/wrictools/blob/main/HowToNoteFile.pdf),
  before you start your study for consistent note taking. If there is a
  TimeStamp in the note e.g “Participants starts eating at 16:10”, the
  time of the creation of the note will be overwritten with the time
  specified in the free-text of the note. The “protocol” is extracted by
  keyword search. You can check currently included keywords and extend
  them by checking the keywords_dict in the extract_note_info() function
  of the preprocessing.R file.
- **keywords_dict:** \[Nested List\] A “dictionary” with keywords for
  extracting protocol information out of the notefile.

The function returns a list with
`r1`\_metadata`,`r2_metadata`,`df_room1`and`df_room2`. Each item of the list is a DataFrame of either the metadata or the preprocessed actual data for either room 1 or 2. If`save_csv\`
is True, then the DataFrames will be saved as csv files with
“id_visit_WRIC_data.csv” or “id_visit_WRIC_metadata.csv”.

As this is probably the most important function I have explained this
here in length. But you can always run

``` r
?preprocess_wric_file
```

to get the description, parameters, return values and examples of how to
use the function or any other function within the package.

For a more detailed tutorial on how to use the package, please look at
vignette `wrictools`.

### Preprocess multiple files on RedCap

If you want to preprocess multiple WRIC files stored on a REDCap server,
you can supply a CSV file containing the record IDs of interest. The
function will automatically fetch the corresponding raw WRIC data,
preprocess it, and return the results.

To connect to your REDCap project, you need your API token and the API
URL for your instance. These should be stored in a local file (for
example ~/.config.R) and sourced when you run the function. A minimal
config file looks like this:

``` r
api_token <- '123C09E18E747592A693467A304EA32'
api_url   <- 'https://redcap.au.dk/api/' #change this url to your RedCAP url (e.g. 'https://redcap.wustl.edu/')
```

**Get your API Token for RedCap**

- Go to your project and click on **API** in the menu on the left-hand
  side.  
- If you cannot find the API option, adjust your rights under **User
  Rights** (or ask the project creator).  
- Request the generation of an API Token.  
- Once approved, you’ll find your Token in the same place.

⚠️ **Important:** Keep your token private and never share or commit it
to version control. If working with sensitive data, consider removing
the token from your config file after use.

You also need to specify the field name of the REDCap instrument where
the raw WRIC data is stored (e.g. “wric_data”) and provide the CSV with
record IDs (one per row, no headers or extra text). The record IDs must
exactly match those used in REDCap.

``` r
# Load your REDCap credentials
source(path.expand("~/.config.R"))

# This creates a temporary csv file with record ID's
tmp_csv <- tempfile(fileext = ".csv")
write.csv(data.frame(X1 = c(1, 2, 3)), tmp_csv, row.names = FALSE)

# Preprocess WRIC files
result <- preprocess_wric_files(
  csv_file   = tmp_csv,
  fieldname  = "wric_data",
  api_url    = api_url,
  api_token  = api_token,
  save_csv   = TRUE,
  combine    = TRUE,
  method     = "mean"
)
```

The function returns a list, where each element corresponds to one
record ID. Each record ID contains its own metadata and preprocessed
data frames for room1 and room2.

## Other good-to-know functions

Remember that you can learn more about each function and it’s usage by
`?function_name`.

- `upload_file_to_redcap` to upload data to RedCAP
- `visualize_with_protocol`to visualize your data including highlights
  of the protocol
- `cut_rows` to cut your dataframe to certain timepoints
- `check-discrepancies`to check the difference between the two sensors
  within a chamber

## Support, Maintenance and Future Work

For any issues, questions, or suggestions feel free to open an issue on
GitHub or reach out to Nina Ziegenbein at <ninzie@ph.au.dk>.

# Package index

## All functions

- [`add_relative_time()`](https://ninaziegenbein.github.io/wrictools/reference/add_relative_time.md)
  :

  Add Relative Time in minutes to DataFrame. Rows before the
  `start_time` will be indicated negative.

- [`check_code()`](https://ninaziegenbein.github.io/wrictools/reference/check_code.md)
  : Check the subject ID code and return corresponding Room 1 and Room 2
  codes.

- [`check_discrepancies()`](https://ninaziegenbein.github.io/wrictools/reference/check_discrepancies.md)
  : Checks for discrepancies between S1 and S2 measurements in the
  DataFrame and prints them to the console. This function is not
  included in the big pre-processing function, as it is more intended to
  perform a quality check on your data and not to automatically inform
  the processing of the data.

- [`combine_measurements()`](https://ninaziegenbein.github.io/wrictools/reference/combine_measurements.md)
  : Combines S1 and S2 measurements in the DataFrame using the specified
  method.

- [`create_wric_df()`](https://ninaziegenbein.github.io/wrictools/reference/create_wric_df.md)
  : Creates DataFrames for wric data from a file and optionally saves
  them as CSV files.

- [`cut_rows()`](https://ninaziegenbein.github.io/wrictools/reference/cut_rows.md)
  : Filters rows in a DataFrame based on an optional start and end
  datetime range.

- [`detect_start_end()`](https://ninaziegenbein.github.io/wrictools/reference/detect_start_end.md)
  : Automatically detect enter and exit from the chamber based on the
  notefile. Returns the start and end times for two participants.

- [`export_file_from_redcap()`](https://ninaziegenbein.github.io/wrictools/reference/export_file_from_redcap.md)
  : Exports a file from REDCap based on the specified record ID and
  field name.

- [`extract_meta_data()`](https://ninaziegenbein.github.io/wrictools/reference/extract_meta_data.md)
  : Extracts metadata for two subjects from text lines and optionally
  saves it as CSV files.

- [`extract_note_info()`](https://ninaziegenbein.github.io/wrictools/reference/extract_note_info.md)
  : Extracts and processes note information from a specified notes file,
  categorizing events based on predefined keywords, and updates two
  DataFrames with protocol information for different participants.

- [`preprocess_wric_file()`](https://ninaziegenbein.github.io/wrictools/reference/preprocess_WRIC_file.md)
  : Preprocesses a wric data file, extracting metadata, creating
  DataFrames, and optionally saving results.

- [`preprocess_wric_files()`](https://ninaziegenbein.github.io/wrictools/reference/preprocess_WRIC_files.md)
  : Preprocesses multiple wric_files by RedCAP record ID, extracting
  metadata, creating DataFrames, and optionally saving results.

- [`upload_file_to_redcap()`](https://ninaziegenbein.github.io/wrictools/reference/upload_file_to_redcap.md)
  : Uploads a file to REDCap for a specified record ID and field name.

- [`visualize_with_protocol()`](https://ninaziegenbein.github.io/wrictools/reference/visualize_with_protocol.md)
  : Visualizes time-series data from a WRIC CSV file, highlighting
  protocol changes and optionally saving the plot.

# Articles

### All vignettes

- [RedCAP](https://ninaziegenbein.github.io/wrictools/articles/RedCAP.md):
- [wrictools](https://ninaziegenbein.github.io/wrictools/articles/wrictools.md):
